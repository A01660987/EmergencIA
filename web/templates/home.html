{% load static %}

<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8">  
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>
            EmergencIA
        </title>
        <link href="{% static 'svg/favicon.svg' %}" rel="icon">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link href="{% static 'css/styles.css' %}" rel="stylesheet">
    </head>
    <body class="bg-light-subtle">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
        <script>
            navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
                const mediaRecorder = new MediaRecorder(stream)
            })
        </script>
        <div class="mt-3 ms-4">
            <img src="{% static 'svg/logo_red.svg' %}" alt="EmergenceAI" height="50">
        </div>
        <div id="resumen" class="mx-4 mt-2 px-4 py-3 rounded text-center text-light" style="background-color: #C10F33">
            <p class="mb-0 fw-bold">RESUMEN DE SITUACIÓN</p>
            <p class="display-5 fw-normal mb-0 pb-2">Lorem ipsum dolor sit amet, consectetur adipiscing elit</p>
        </div>
        <div class="row mt-4 mx-4">
            <div class="col-7 p-4 bg-white rounded">
                <p id="status">Connection status:</p>
                <button id="startRecording">Start Recording</button>
                <button id="stopRecording" disabled>Stop Recording</button>
                <p class="fs-6 mb-0 fw-bold">
                  TRANSCRIPCIÓN
                </p>
                <p id="transcript" class="fs-5 mb-0">
                </p>
            </div>
            <div class="col my-3 text-center fs-5 fw-semibold">
                Servicio de emergencia recomendado:
                <p class="display-3 fw-bold">Ambulancia</p>
            </div>
        <!-- JAVASCRIPT FILES -->
        <script>
            const socket = new WebSocket('ws://localhost:8000/listen')
        </script>
        <script>
            navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
                const mediaRecorder = new MediaRecorder(stream)
            })

            socket.onopen = () => {
                document.querySelector('#status').textContent = 'Connected'
                console.log({
                    event: 'onopen'
                })
                mediaRecorder.addEventListener('dataavailable', async (event) => {
                    if (event.data.size > 0 && socket.readyState == 1) {
                        socket.send(event.data)
                    }
                })
                mediaRecorder.start(250)
            }
        
            socket.onmessage = (message) => {
                const received = message.data
                if (received) {
                    console.log(received)
                    document.querySelector('#transcript').textContent += ' ' + received
                }
            }
        
            socket.onclose = () => {
                console.log({
                    event: 'onclose'
                })
            }
        
            socket.onerror = (error) => {
                console.log({
                    event: 'onerror',
                    error
                })
            }
    </script>
    <!-- <script>
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
            const mediaRecorder = new MediaRecorder(stream)
        })
    </script> -->
    <!-- <script src="../static/js/audio-record-script.js"></script> -->
    </body>
</html>